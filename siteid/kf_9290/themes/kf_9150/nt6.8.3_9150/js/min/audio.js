!function(a,b){var c="recorder_worker.js";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null,window.AudioContext=window.AudioContext||window.webkitAudioContext||window.msAudioContext||null,window.URL=window.URL||window.webkitURL||null,a.Audio={inited:!1,rec:null,formData:null,support:function(){return!(!navigator.getUserMedia||!window.AudioContext)},createAudio:function(b,c){var d=!!document.createElement("video").canPlayType;return d?a(c).find("audio").length?a(c).find("audio").attr("src",b):a({tag:"AUDIO"}).appendTo(c).attr("src",b):(a.Log("Browser does not support audio.",3),null)},start:function(b,c,d){var e=this;if(this.fileTranServer=b||"",this.options=c||{},this.support()===!1)return a.Log("Browser does not support getUserMedia or AudioContext.",2),!1;var f=a({tag:"IFRAME",src:b+"/proxy.html?t="+a.getTime(),style:a.STYLE_NBODY+"width:1px;height:1px;visibility:hidden;"}).appendTo(a(".chat-view-button-audio")).get(0);this.proxy=f.contentWindow;try{navigator.getUserMedia({audio:!0},function(a){d(!1),e._success(a),e.inited=!0},function(a){d(!0),e._failure(a),e.inited=!0}),setTimeout(function(){e.inited||(d(!0),e._failure(event),e.inited=!1)},2e3)}catch(g){a.Log("navigator.getUserMedia:"+g.message,3)}},record:function(){return!(!this.rec||!this.inited)&&void this.rec.record()},end:function(b){var c=this;return!(!this.rec||!this.inited)&&(this.rec.stop(),void this.rec.exportWAV(function(d){c.rec.clear(),a.Log(d,2),c._upload(d,b)}))},_upload:function(b,c){var d=this;this.rec.clear(),this.formData=new FormData,this.formData.append("userfile",b),this.formData.append("fname",a.getTime()+".wav"),a.each(this.options,function(a,b){d.formData.append(a,b)});try{this.proxy.uploadFile(this.fileTranServer+"/imageupload.php",this.formData,c)}catch(e){a.Log("$.Audio._upload():"+e.message,3)}},_success:function(b){a.Log("nTalk.Audio._success()");var c=new window.AudioContext,d=c.createMediaStreamSource(b),e={workerPath:"recorder_worker.js"};this.rec=new a.Recorder(d,e)},_failure:function(b){a.Log("nTalk.Audio._failure()")}},a.Recorder=function(b,d){var e,f,g=d||{},h=g.bufferLen||4096,i=!1;this.context=b.context,this.context.createJavaScriptNode?this.node=this.context.createJavaScriptNode(h,2,2):this.node=this.context.createScriptProcessor(h,2,2);try{e=new Worker(g.workerPath||c)}catch(j){a.Log(j,3)}e.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}}),this.node.onaudioprocess=function(a){i&&e.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(self.config[b]=a[b])},this.record=function(){i=!0},this.stop=function(){i=!1},this.clear=function(){e.postMessage({command:"clear"})},e.onmessage=function(a){var b=a.data;f(b)},this.getBuffer=function(a){f=a||g.callback,e.postMessage({command:"getBuffer"})},this.exportWAV=function(a,b){if(f=a||g.callback,b=b||g.type||"audio/wav",!f)throw new Error("Callback not set");e.postMessage({command:"exportWAV",type:b})},b.connect(this.node),this.node.connect(this.context.destination)}}(nTalk);